<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TRX Depósitos y Retiros (TronLink + Firebase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- TronWeb CDN para fallback de lecturas si TronLink no está disponible -->
  <script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js"></script>
  <style>
    :root { --bg:#0b0f19; --card:#131a2a; --border:#223154; --text:#e6e9ef; --muted:#9fb0d3; --green:#57d18b; --red:#ff7b7b; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--text); margin:20px; }
    h1 { font-size:22px; margin-bottom:8px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px; }
    label { display:block; font-weight:600; margin-bottom:6px; }
    input, button { padding:10px; border-radius:8px; border:1px solid #33456b; background:#0e1422; color:var(--text); }
    input { width:100%; margin-bottom:10px; }
    button { cursor:pointer; margin-right:6px; }
    .row { display:grid; grid-template-columns: 1fr; gap:10px; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .muted { color:var(--muted); font-size:12px; }
    .success { color:var(--green); }
    .error { color:var(--red); }
    pre { background:#0e1422; padding:10px; border-radius:8px; overflow:auto; }
    a { color:#70b3ff; text-decoration:none; }
  </style>
</head>
<body>
  <h1>Demo TRX + TronLink + Firebase</h1>
  <p class="muted">Conecta TronLink para firmar retiros sin exponer tu clave privada. Lecturas vía TronGrid.</p>

  <div class="card">
    <div class="grid-2">
      <div>
        <label>Conexión de wallet</label>
        <button id="connect">Conectar TronLink</button>
        <p id="walletInfo" class="muted">Estado: no conectado</p>
      </div>
      <div>
        <label>Accesos rápidos</label>
        <div class="row">
          <button id="getMyBalance">Mi balance</button>
          <button id="stakeInfo">Mi energía/bandwidth</button>
          <a id="openMyTronscan" target="_blank"><button>Abrir mi dirección en Tronscan</button></a>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <label>Operaciones de lectura</label>
    <input id="address" placeholder="Dirección TRX (ej: TGuYh...)" />
    <div class="row">
      <button id="validateAddress">Validar dirección</button>
      <button id="getBalance">Consultar balance</button>
      <button id="getIncoming">Ver transacciones entrantes</button>
      <a id="openTronscan" target="_blank"><button>Abrir en Tronscan</button></a>
    </div>
    <p class="muted">Tip: envía 1 TRX de prueba para ver actividad.</p>
    <div id="status"></div>
  </div>

  <div class="card">
    <label>Retiros firmados con TronLink</label>
    <input id="withdrawTo" placeholder="Dirección destino (TRX)" />
    <input id="withdrawAmount" type="number" step="0.000001" placeholder="Monto TRX (ej: 1.5)" />
    <div class="row">
      <button id="withdraw">Enviar retiro (firma con TronLink)</button>
      <button id="logWithdraw">Registrar retiro en Firebase (sin enviar)</button>
    </div>
    <p class="muted">La transacción se firmará con tu wallet de TronLink. Debes tener TRX para fees.</p>
  </div>

  <div class="card">
    <label>Resultados</label>
    <pre id="output">// JSON de lecturas, firmas y registros</pre>
  </div>

  <div class="card">
    <label>Seguridad y notas</label>
    <p class="muted">
      - Nunca expongas claves privadas en el navegador. Usa TronLink para firmar. <br/>
      - Este demo guarda eventos en Firebase (colecciones: depositos, retiros). <br/>
      - Para producción, mueve lógica sensible (límites, validaciones adicionales) a backend.
    </p>
  </div>

  <script>
    // -------- Firebase --------
    const firebaseConfig = {
      apiKey: "AIzaSyAi4QOp1WzDUMx2owRl-cPvF5EvWeD5x10",
      authDomain: "trx-hoy.firebaseapp.com",
      projectId: "trx-hoy",
      storageBucket: "trx-hoy.firebasestorage.app",
      messagingSenderId: "141306706252",
      appId: "1:141306706252:web:385728a8561c51254cf7e9",
      measurementId: "G-BFSFV46P9Q"
    };
    const appFB = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const analytics = firebase.analytics();

    // -------- TronWeb & TronLink --------
    let tron = null;       // instancia para lecturas (TronGrid)
    let tronLink = null;   // instancia inyectada por TronLink para firmas

    function tronscanUrl(addr){ return `https://tronscan.org/#/address/${addr}`; }
    const $status = document.getElementById('status');
    const $output = document.getElementById('output');
    const $address = document.getElementById('address');
    const $walletInfo = document.getElementById('walletInfo');
    const $openMyTronscan = document.getElementById('openMyTronscan');
    const $openTronscan = document.getElementById('openTronscan');

    function setStatus(msg, type='muted'){ $status.innerHTML = `<p class="${type}">${msg}</p>`; }
    function print(obj){ $output.textContent = typeof obj==='string' ? obj : JSON.stringify(obj, null, 2); }

    // Inicializar TronWeb para lecturas
    tron = new TronWeb({ fullHost: 'https://api.trongrid.io' });

    // Detectar TronLink y preparar instancia firmante
    async function ensureTronLink(){
      if (window.tronWeb && window.tronWeb.defaultAddress && window.tronWeb.defaultAddress.base58) {
        tronLink = window.tronWeb;
        const addr = tronLink.defaultAddress.base58;
        $walletInfo.textContent = `Estado: conectado como ${addr}`;
        $openMyTronscan.href = tronscanUrl(addr);
        return true;
      }
      $walletInfo.textContent = 'Estado: TronLink no detectado. Instálalo y desbloquea tu wallet.';
      return false;
    }

    // Botón conectar
    document.getElementById('connect').onclick = async () => {
      // TronLink moderno expone window.tronLink?.request({ method: 'tron_requestAccounts' })
      try {
        if (window.tronLink && window.tronLink.request) {
          await window.tronLink.request({ method: 'tron_requestAccounts' });
        }
        const ok = await ensureTronLink();
        $walletInfo.className = ok ? 'success' : 'error';
      } catch (e) {
        $walletInfo.textContent = 'Error conectando TronLink.';
        $walletInfo.className = 'error';
      }
    };

    // Validar dirección
    document.getElementById('validateAddress').onclick = () => {
      const addr = $address.value.trim();
      if (!addr) return setStatus('Ingresa una dirección TRX.', 'error');
      const valid = tron.isAddress(addr);
      setStatus(valid ? 'Dirección válida en Tron.' : 'Dirección inválida.', valid ? 'success' : 'error');
      if (valid) $openTronscan.href = tronscanUrl(addr);
    };

    // Balance de dirección ingresada
    document.getElementById('getBalance').onclick = async () => {
      const addr = $address.value.trim();
      if (!tron.isAddress(addr)) return setStatus('Dirección inválida.', 'error');
      try {
        setStatus('Consultando balance...', 'muted');
        const sun = await tron.trx.getBalance(addr);
        const trx = sun / 1e6;
        print({ address: addr, balanceSUN: sun, balanceTRX: trx });
        setStatus('Balance obtenido.', 'success');
      } catch (e) { setStatus('Error obteniendo balance.', 'error'); print(String(e)); }
    };

    // Transacciones entrantes
    document.getElementById('getIncoming').onclick = async () => {
      const addr = $address.value.trim();
      if (!tron.isAddress(addr)) return setStatus('Dirección inválida.', 'error');
      try {
        setStatus('Buscando transacciones...', 'muted');
        const txs = await tron.trx.getTransactionsRelated(addr, 'incoming', 1, 20);
        print(txs || []);
        setStatus(Array.isArray(txs) && txs.length ? 'Transacciones encontradas.' : 'Sin transacciones entrantes.', 'success');
      } catch (e) { setStatus('Error consultando transacciones.', 'error'); print(String(e)); }
    };

    // Mi balance (wallet conectada)
    document.getElementById('getMyBalance').onclick = async () => {
      const ok = await ensureTronLink();
      if (!ok) return;
      try {
        const addr = tronLink.defaultAddress.base58;
        const sun = await tron.trx.getBalance(addr);
        const trx = sun / 1e6;
        print({ myAddress: addr, balanceSUN: sun, balanceTRX: trx });
        setStatus('Balance de tu wallet obtenido.', 'success');
      } catch (e) { setStatus('Error consultando tu balance.', 'error'); print(String(e)); }
    };

    // Mi energía/bandwidth
    document.getElementById('stakeInfo').onclick = async () => {
      const ok = await ensureTronLink(); if (!ok) return;
      try {
        const addr = tronLink.defaultAddress.base58;
        const res = await tron.trx.getAccountResources(addr);
        print({ address: addr, resources: res });
        setStatus('Recursos de cuenta obtenidos.', 'success');
      } catch (e) { setStatus('Error consultando recursos.', 'error'); print(String(e)); }
    };

    // Guardar depósito manual en Firebase
    document.getElementById('saveDeposit').onclick = async () => {
      const addr = $address.value.trim();
      if (!tron.isAddress(addr)) return setStatus('Dirección inválida.', 'error');
      try {
        const docRef = await db.collection('depositos').add({
          direccion: addr,
          fecha: new Date(),
          nota: 'Depósito registrado manualmente desde el cliente'
        });
        print({ firebaseDocId: docRef.id, type: 'deposito', address: addr });
        setStatus('Depósito registrado en Firebase.', 'success');
      } catch (e) { setStatus('Error guardando depósito.', 'error'); print(String(e)); }
    };

    // Retiro firmado con TronLink (envía TRX)
    document.getElementById('withdraw').onclick = async () => {
      const ok = await ensureTronLink(); if (!ok) return setStatus('Conecta TronLink primero.', 'error');
      const to = document.getElementById('withdrawTo').value.trim();
      const amountTRX = parseFloat(document.getElementById('withdrawAmount').value);
      if (!tron.isAddress(to)) return setStatus('Destino inválido.', 'error');
      if (!amountTRX || amountTRX <= 0) return setStatus('Monto inválido.', 'error');

      try {
        setStatus('Construyendo y firmando transacción...', 'muted');
        const from = tronLink.defaultAddress.base58;
        const amountSUN = Math.round(amountTRX * 1e6);
        const tx = await tronLink.transactionBuilder.sendTrx(to, amountSUN, from);
        const signed = await tronLink.trx.sign(tx);              // TronLink firma con tu wallet
        const sent = await tronLink.trx.sendRawTransaction(signed);

        // Guardar retiro en Firebase
        await db.collection('retiros').add({
          origen: from,
          destino: to,
          montoTRX: amountTRX,
          fecha: new Date(),
          resultado: sent
        });

        print({ from, to, amountTRX, txResult: sent });
        setStatus(sent.result ? 'Retiro enviado.' : 'No se pudo enviar el retiro.', sent.result ? 'success' : 'error');
      } catch (e) {
        setStatus('Error firmando/enviando retiro.', 'error');
        print(String(e));
      }
    };

    // Registrar retiro en Firebase sin enviar (para auditoría)
    document.getElementById('logWithdraw').onclick = async () => {
      const to = document.getElementById('withdrawTo').value.trim();
      const amountTRX = parseFloat(document.getElementById('withdrawAmount').value);
      if (!tron.isAddress(to)) return setStatus('Destino inválido.', 'error');
      if (!amountTRX || amountTRX <= 0) return setStatus('Monto inválido.', 'error');
      try {
        const ok = await ensureTronLink();
        const from = ok ? tronLink.defaultAddress.base58 : null;
        const docRef = await db.collection('retiros').add({
          origen: from,
          destino: to,
          montoTRX: amountTRX,
          fecha: new Date(),
          nota: 'Registro sin envío (solo auditoría)'
        });
        print({ firebaseDocId: docRef.id, type: 'retiro-log', from, to, amountTRX });
        setStatus('Retiro registrado en Firebase (sin enviar).', 'success');
      } catch (e) { setStatus('Error registrando retiro.', 'error'); print(String(e)); }
    };
  </script>
</body>
</html>
